<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Microbit-V2: Partial Flashing Service</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Microbit-V2<span id="projectnumber">&#160;1.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__new_folder_codal_microbit_v2_docs_bluetooth__micro_bit_partial_flashing.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Partial Flashing Service </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md5"></a>
Introduction</h1>
<p >The Partial Flashing Service allows a BLE client to connect to a micro:bit and read and write the information required to partially update the flash contents. For MakeCode programs this usually means updating the user's script (compiled to asm), and for Python programs this is the entire file system.</p>
<p >This service exists in partnership with the DFU service that allows a client to fully flash the application storage of the micro:bit (for example, for switching between a MicroPython programme and a MakeCode programme).</p>
<p >Diagrams showing the flow of data during partial flashing can be found at partial flashing client "the bottom of the document".</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Bluetooth Service Specification</h1>
<p >The micro:bit v2 follows the same BLE specification as the micro:bit v1. The specification can be found <a href="https://lancaster-university.github.io/microbit-docs/resources/bluetooth/bluetooth_profile.html">here</a></p>
<h1><a class="anchor" id="autotoc_md7"></a>
Enabling the service</h1>
<p >In order to work properly, the partial flashing service requires certain things to be true about the memory map, and it must be possible for the MemoryMapService to be able to build a model of the flash layout. Most significantly, the service is ideal for updating data outside the main C/C++ build containing CODAL. This is currently possible for MakeCode and MicroPython builds, but not trivial for CODAL programs, where the program is linked into a single executable.</p>
<p >The partial flashing service is included by default in MakeCode builds for micro:bit V1 (using microbit-dal, not CODAL) and V2, and MicroPython builds for micro:bit V2 only. The Partial Flashing service is available in both application and pairing modes.</p>
<ul>
<li>MakeCode: Enabled V1 (microbit-dal) and V2 (CODAL)</li>
<li>MicroPython: Enabled on V2 only (CODAL)</li>
</ul>
<p >To enable it in a CODAL build the <code>MICROBIT_BLE_PARTIAL_FLASHING</code> option is set to <code>1</code> in <code>codal.json</code></p>
<div class="fragment"><div class="line">&quot;config&quot;:{</div>
<div class="line">        &quot;SOFTDEVICE_PRESENT&quot;: 1,</div>
<div class="line">        &quot;DEVICE_BLE&quot;: 1,</div>
<div class="line">        &quot;MICROBIT_BLE_ENABLED&quot; : 1,</div>
<div class="line">        &quot;MICROBIT_BLE_PAIRING_MODE&quot;: 1,</div>
<div class="line">        &quot;MICROBIT_BLE_DFU_SERVICE&quot;: 1,</div>
<div class="line">        &quot;MICROBIT_BLE_DEVICE_INFORMATION_SERVICE&quot;: 1,</div>
<div class="line">        &quot;MICROBIT_BLE_EVENT_SERVICE&quot; : 1,</div>
<div class="line">        &quot;MICROBIT_BLE_PARTIAL_FLASHING&quot; : 1,</div>
<div class="line">        &quot;MICROBIT_BLE_SECURITY_LEVEL&quot;: &quot;SECURITY_MODE_ENCRYPTION_NO_MITM&quot;</div>
<div class="line">    }</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md8"></a>
Characteristic Commands</h1>
<p >The service consists of a single Bluetooth GATT characteristic that responds to a client's WRITE WITHOUT RESPONSE request with a BLE Notification. The characteristic supports commands to:</p>
<ul>
<li>Read the REGION INFO</li>
<li>WRITE DATA to the flash</li>
<li>Inform the micro:bit that the sevice has reached END OF TRANSMISSION</li>
<li>Obtain the MICROBIT STATUS (PFS version #, current m:b mode)</li>
<li>RESET the micro:bit into either application (MakeCode) or BLE mode.</li>
</ul>
<p >These are documented below:</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Region Info Command</h2>
<p >The Region Info command is used to request information from the Memory Map. The client sends a WRITE WITHOUT RESPONSE command with the control byte (byte 0) set to 0x00 (Region Info) and byte 1 set to the region ID:</p>
<h3><a class="anchor" id="autotoc_md10"></a>
Client Write Request</h3>
<h3><a class="anchor" id="autotoc_md11"></a>
MakeCode</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"></th><th class="markdownTableHeadNone">Byte 0 / Command   </th><th class="markdownTableHeadNone">Byte 1 / Region #    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Read Soft Device   </td><td class="markdownTableBodyNone">0x00   </td><td class="markdownTableBodyNone">0x00    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Read CODAL   </td><td class="markdownTableBodyNone">0x00   </td><td class="markdownTableBodyNone">0x01    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Read MakeCode   </td><td class="markdownTableBodyNone">0x00   </td><td class="markdownTableBodyNone">0x02   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md12"></a>
Python</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"></th><th class="markdownTableHeadNone">Byte 0 / Command   </th><th class="markdownTableHeadNone">Byte 1 / Region #    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Read Soft Device   </td><td class="markdownTableBodyNone">0x00   </td><td class="markdownTableBodyNone">0x00    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Read MicroPython   </td><td class="markdownTableBodyNone">0x00   </td><td class="markdownTableBodyNone">0x01    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Read FileSystem   </td><td class="markdownTableBodyNone">0x00   </td><td class="markdownTableBodyNone">0x02   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md13"></a>
micro:bit Response</h3>
<p >The micro:bit looks up the relevant information and returns it using a BLE NOTIFICATION:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Byte 0   </th><th class="markdownTableHeadNone">Byte 1   </th><th class="markdownTableHeadNone">Bytes [2,3,4,5]   </th><th class="markdownTableHeadNone">Bytes [6,7,8,9]   </th><th class="markdownTableHeadNone">Bytes [10,11,12,13,14,15,16,17]    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">READ_NOTIFICATION / 0x00   </td><td class="markdownTableBodyNone">Region #   </td><td class="markdownTableBodyNone">Region Start Address   </td><td class="markdownTableBodyNone">Region End Address   </td><td class="markdownTableBodyNone">Hash   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md14"></a>
Write Data Command</h2>
<p >To send the new firmware and write it to the flash a WRITE_WITHOUT_RESPONSE command is used. These packets begin with the command byte (byte 0) set to 0x01. The packet is structured as follows:</p>
<h3><a class="anchor" id="autotoc_md15"></a>
Client Write Without Response</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">1 Byte   </th><th class="markdownTableHeadNone">2 Bytes   </th><th class="markdownTableHeadNone">1 Byte   </th><th class="markdownTableHeadNone">16 Bytes    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">COMMAND   </td><td class="markdownTableBodyNone">OFFSET   </td><td class="markdownTableBodyNone">PACKET#   </td><td class="markdownTableBodyNone">DATA   </td></tr>
</table>
<p >The micro:bit handles data in blocks of 4 packets. This allows the micro:bit to keep a 64 byte buffer and ensure that it can be successfully processed before moing onto the next block.</p>
<p >The address of the current block is split between the first two packets. The first packet contains the lower 2 bytes of the address, and the second packet contains the upper 2 bytes of the address.</p>
<div class="fragment"><div class="line">// blockNum is 0: set up the offset</div>
<div class="line">case 0:</div>
<div class="line">    {</div>
<div class="line">        offset = ((data[1] &lt;&lt; 8) | data[2] &lt;&lt; 0);</div>
<div class="line">        blockNum++;</div>
<div class="line">        break;</div>
<div class="line">    }</div>
<div class="line">// blockNum is 1: complete the offset</div>
<div class="line">case 1:</div>
<div class="line">    {</div>
<div class="line">        offset |= ((data[1] &lt;&lt; 24) | data[2] &lt;&lt; 16);</div>
<div class="line">        blockNum++;</div>
<div class="line">        break;</div>
<div class="line">    }</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md16"></a>
micro:bit Response</h3>
<p ><b>Successful Write:</b></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Byte 0   </th><th class="markdownTableHeadNone">Byte 1    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">WRITE_NOTIFICATION / 0x01   </td><td class="markdownTableBodyNone">0xFF   </td></tr>
</table>
<p ><b>Out Of Order Packet</b> If the micro:bit detects an out of order packet the packet count is set to the end of the block (start of block + 3, ready for the next) and a notification is sent to inform the client. The client needs to update the packet # to the start of the next block - add 4 to the start of the block (block packet counts always start with a multiple of 4: 0, 4, 8, 12..).</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Byte 0   </th><th class="markdownTableHeadNone">Byte 1    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">WRITE NOTIFICATION / 0x01   </td><td class="markdownTableBodyNone">0xAA   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md17"></a>
End Of Transmission</h2>
<p >When the start of the embedded source is reached a WRITE_WITHOUT_RESPONSE request is issued with a payload of 0x02. The micro:bit removes the embedded source magic to prevent confusion with the new application, and resets the micro:bit into application mode.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Byte 0    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">END_OF_TX / 0x02   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md18"></a>
MICROBIT STATUS</h2>
<p >A client can fetch the version of the Partial Flashing Service and the micro:bit's current status using the MICROBIT STATUS command.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Byte 0    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MICROBIT STATUS / 0xEE   </td></tr>
</table>
<p >The micro:bit responds with a notification. Partial Flashing Version, currently returns 1 for the intial release. Current mode returns: 0x00 for Pairing Mode, 0x01 for Application Mode.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Byte 0   </th><th class="markdownTableHeadNone">Byte 1   </th><th class="markdownTableHeadNone">Byte 2    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MICROBIT STATUS / 0xEE   </td><td class="markdownTableBodyNone">Partial Flashing Version   </td><td class="markdownTableBodyNone">Current Mode   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md19"></a>
MICROBIT RESET</h2>
<p >The Partial Flashing Service also allows a client to reset a micro:bit into either Application or Bluetooth Pairing Mode.</p>
<p >Reset Type: 0x00 for Pairing Mode, 0x01 for Application Mode</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Byte 0   </th><th class="markdownTableHeadNone">Byte 1    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MICROBIT RESET / 0xFF   </td><td class="markdownTableBodyNone">Reset Mode   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md20"></a>
UUIDs</h2>
<div class="fragment"><div class="line">const uint8_t  MicroBitPartialFlashServiceUUID[] = {</div>
<div class="line">    0xe9,0x7d,0xd9,0x1d,0x25,0x1d,0x47,0x0a,0xa0,0x62,0xfa,0x19,0x22,0xdf,0xa9,0xa8</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">const uint8_t  MicroBitPartialFlashServiceCharacteristicUUID[] = {</div>
<div class="line">    0xe9,0x7d,0x3b,0x10,0x25,0x1d,0x47,0x0a,0xa0,0x62,0xfa,0x19,0x22,0xdf,0xa9,0xa8</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md21"></a>
Partial Flashing Client</h1>
<h2><a class="anchor" id="autotoc_md22"></a>
Example Client for Android</h2>
<p >Please see an example implementation <a href="https://github.com/microbit-foundation/android-partial-flashing-lib">on GitHub</a>.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Client Process</h2>
<p >A client completing the partial flashing process will first need to read the Memory Map from the micro:bit to obtain the region hashes.</p>
<p >Once the hashes have been obtained from the micro:bit they need to be compared with the hashes found within the new hex file to determine if it is possible to partially flash the micro:bit. Partial flashing requires the micro:bit to be using a matching version of the CODAL or MicroPython.</p>
<p ><img src="/resources/DeterminePF.png" alt="Determine Partial Flashing" class="inline"/></p>
<p >If partial flashing is possible the micro:bit needs to be in BLE mode to prevent the flashing process from interfering with instructions that are executing. This is done by sending a <code>MICROBIT_RESET</code> command with <code>0x00</code> as the payload.</p>
<p >Once the region is completely transferred, the client needs to send an END OF TRANSMISSION BLE WRITE to inform the micro:bit the transfer is over. The micro:bit will the erase any remaining pages in the region, clear flags keeping it in partial flashing mode, and then reset into the transferred program.</p>
<p ><img src="/resources/PFFlow.png" alt="Do Partial Flashing" class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
